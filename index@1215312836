<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CyberSudoku 2077 v4.0 (UX)</title>
    <style>
        :root {
            /* --- CYBERPUNK THEME PALETTE --- */
            --cp-bg-dark: #101827;
            --cp-bg-card: #1f2937;
            --cp-neon-blue: #00FFFF;
            --cp-neon-magenta: #FF00FF;
            --cp-neon-green: #00FF7F;
            --cp-text-light: #E5E7EB;
            --cp-text-subtle: #9CA3AF;
            
            /* Game Specific Mappings */
            --highlight-color: rgba(0, 255, 255, 0.1);
            --same-num-highlight: rgba(255, 0, 255, 0.2);
            --selected-bg: var(--cp-neon-blue);
            --selected-text: #000000;
            
            --text-fixed: var(--cp-neon-blue);
            --text-user: var(--cp-neon-green);
            --text-error: var(--cp-neon-magenta);
        }

        @keyframes neonGlow {
            0% { box-shadow: 0 0 5px var(--cp-neon-blue), 0 0 10px var(--cp-neon-blue); }
            100% { box-shadow: 0 0 10px var(--cp-neon-blue), 0 0 15px var(--cp-neon-blue); }
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Glitch Animation */
        @keyframes glitch {
            0% { transform: translate(0); text-shadow: 0 0 10px var(--cp-neon-blue); }
            2% { transform: translate(-2px, 2px); text-shadow: 2px 0 var(--cp-neon-magenta), -2px 0 var(--cp-neon-green); }
            4% { transform: translate(2px, -2px); text-shadow: -2px 0 var(--cp-neon-magenta), 2px 0 var(--cp-neon-green); }
            6% { transform: translate(0); text-shadow: 0 0 10px var(--cp-neon-blue); }
            100% { transform: translate(0); text-shadow: 0 0 10px var(--cp-neon-blue); }
        }

        body {
            font-family: 'Courier New', Courier, monospace, 'Inter', sans-serif;
            background-color: var(--cp-bg-dark);
            color: var(--cp-text-light);
            min-height: 100vh;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            background: linear-gradient(-45deg, #101827, #0c121d, #101827, #2d1b36);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px 0;
        }

        /* CRT Overlay Effect */
        .crt-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 100;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            opacity: 0.4; /* Toned down for better visibility */
        }

        /* ‰∏ªÂÆπÂô®Âç°Áâá */
        .game-card {
            background-color: rgba(31, 41, 55, 0.85); /* Slightly more opaque for readability */
            border: 1px solid rgba(0, 255, 255, 0.3);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2), inset 0 0 20px rgba(31, 41, 55, 0.8);
            border-radius: 8px;
            padding: 24px;
            width: 100%;
            max-width: 480px;
            display: flex;
            flex-direction: column;
            align-items: center;
            backdrop-filter: blur(15px);
            position: relative;
            overflow: hidden;
            z-index: 10;
        }

        /* Ë£ùÈ£æÊÄßËßíËêΩ */
        .game-card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 20px; height: 20px;
            border-top: 2px solid var(--cp-neon-magenta); border-left: 2px solid var(--cp-neon-magenta);
        }
        .game-card::after {
            content: ''; position: absolute; bottom: 0; right: 0; width: 20px; height: 20px;
            border-bottom: 2px solid var(--cp-neon-magenta); border-right: 2px solid var(--cp-neon-magenta);
        }

        /* Header */
        .header {
            width: 100%; display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; border-bottom: 1px solid rgba(0, 255, 255, 0.3); padding-bottom: 10px;
        }
        .title {
            font-size: 1.8rem; font-weight: 800; color: var(--cp-neon-blue); text-transform: uppercase;
            letter-spacing: 2px; text-shadow: 0 0 10px rgba(0, 255, 255, 0.8);
            animation: glitch 5s infinite;
        }
        .stats-area {
            display: flex; gap: 12px; font-size: 0.9rem; font-weight: 700; color: var(--cp-text-subtle);
            align-items: center; font-family: monospace;
        }
        .stat-item {
            background: rgba(12, 18, 29, 0.6); border: 1px solid rgba(0, 255, 255, 0.2);
            padding: 4px 10px; border-radius: 4px; display: flex; align-items: center; gap: 6px;
        }

        /* Controls */
        .controls {
            width: 100%; display: flex; gap: 8px; margin-bottom: 16px; justify-content: space-between; flex-wrap: wrap;
        }
        .control-group { display: flex; gap: 8px; }

        select, button {
            font-family: monospace; font-weight: 700; cursor: pointer; border-radius: 4px; backdrop-filter: blur(5px);
            outline: none; transition: all 0.2s;
        }

        select {
            padding: 8px 12px; border: 1px solid rgba(0, 255, 255, 0.3);
            background: rgba(12, 18, 29, 0.6); color: var(--cp-neon-blue);
        }

        .icon-btn {
            width: 40px; height: 40px; border: 1px solid rgba(255, 0, 255, 0.5);
            background: rgba(62, 42, 77, 0.6); color: var(--cp-neon-magenta);
            display: flex; align-items: center; justify-content: center; font-size: 1.2rem;
        }
        .icon-btn:hover {
            background: rgba(85, 51, 102, 0.8); color: var(--cp-text-light); box-shadow: 0 0 10px var(--cp-neon-magenta);
        }

        .btn-new-game {
            background: rgba(26, 52, 77, 0.6); color: var(--cp-neon-blue);
            border: 1px solid rgba(0, 255, 255, 0.5); padding: 0 16px; font-size: 0.9rem;
        }
        .btn-new-game:hover {
            background: rgba(42, 76, 110, 0.8); color: var(--cp-text-light); box-shadow: 0 0 10px var(--cp-neon-blue);
        }

        /* Board */
        .board-wrapper {
            position: relative; width: 100%; aspect-ratio: 1; margin-bottom: 20px;
            border-radius: 4px; overflow: hidden; border: 1px solid rgba(0, 255, 255, 0.3);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.15);
        }
        .sudoku-board {
            display: grid; grid-template-columns: repeat(9, 1fr); grid-template-rows: repeat(9, 1fr);
            background: rgba(0, 255, 255, 0.5); width: 100%; height: 100%; gap: 1px;
        }
        .cell {
            background: rgba(16, 24, 39, 0.95); display: flex; align-items: center; justify-content: center;
            font-size: 1.6rem; cursor: pointer; position: relative; transition: all 0.1s;
            font-family: 'Courier New', monospace;
        }
        /* 3x3 Grid Lines */
        .cell:nth-child(3n) { margin-right: 2px; }
        .cell:nth-child(9n) { margin-right: 0; }
        .cell:nth-child(n+19):nth-child(-n+27), .cell:nth-child(n+46):nth-child(-n+54) { margin-bottom: 2px; }

        /* Cell States */
        .cell.fixed { font-weight: 800; color: var(--text-fixed); text-shadow: 0 0 8px rgba(0, 255, 255, 0.6); }
        .cell.user-input { color: var(--text-user); font-weight: 700; text-shadow: 0 0 8px rgba(0, 255, 127, 0.5); }
        .cell.highlight { background-color: var(--highlight-color); }
        .cell.same-number { background-color: var(--same-num-highlight); box-shadow: inset 0 0 15px rgba(255, 0, 255, 0.2); }
        .cell.selected {
            background-color: var(--selected-bg) !important; color: var(--selected-text) !important;
            box-shadow: 0 0 20px var(--cp-neon-blue); z-index: 10; border: 1px solid #fff;
        }
        .cell.error {
            background-color: rgba(255, 0, 255, 0.2) !important; color: var(--text-error) !important;
            animation: shake 0.3s;
        }

        @keyframes shake {
            0% { transform: translateX(0); } 25% { transform: translateX(-4px); }
            75% { transform: translateX(4px); } 100% { transform: translateX(0); }
        }

        /* Notes */
        .notes-grid {
            position: absolute; top: 2px; left: 2px; right: 2px; bottom: 2px;
            display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); pointer-events: none;
        }
        .note-num {
            display: flex; align-items: center; justify-content: center; font-size: 0.65rem;
            color: var(--cp-text-subtle); line-height: 1; font-weight: 600;
        }
        .cell.selected .note-num { color: rgba(0,0,0,0.6); }

        /* Numpad & Tools */
        .numpad-container { width: 100%; }
        
        /* New Mode Switcher Styles */
        .mode-switch {
            width: 100%; margin-bottom: 12px; display: flex; gap: 0;
            border: 1px solid var(--cp-neon-blue); border-radius: 4px; overflow: hidden;
        }
        .mode-btn {
            flex: 1; padding: 8px; background: rgba(16, 24, 39, 0.8);
            color: var(--cp-text-subtle); border: none; font-size: 0.9rem;
            border-radius: 0;
        }
        .mode-btn.active {
            background: var(--cp-neon-blue); color: #000; font-weight: 800;
            box-shadow: 0 0 10px var(--cp-neon-blue);
        }

        .tools-row { display: flex; gap: 10px; margin-bottom: 12px; }
        .tool-btn {
            flex: 1; padding: 10px; border-radius: 4px;
            border: 1px solid rgba(156, 163, 175, 0.3); background: rgba(17, 24, 39, 0.6);
            color: var(--cp-text-subtle); font-weight: 600; display: flex; align-items: center; justify-content: center;
            gap: 6px; font-size: 0.85rem;
        }
        .tool-btn:hover { border-color: var(--cp-neon-blue); color: var(--cp-neon-blue); }
        .tool-btn.active { background: var(--cp-neon-blue); color: #000; border-color: var(--cp-neon-blue); }

        .numpad { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
        .num-btn {
            aspect-ratio: 1; border-radius: 4px; border: 1px solid rgba(0, 255, 255, 0.3);
            background: rgba(26, 34, 48, 0.6); color: var(--cp-neon-blue);
            font-size: 1.5rem; font-weight: 700; display: flex; align-items: center; justify-content: center;
            position: relative;
        }
        .num-btn:hover { background: rgba(42, 76, 110, 0.8); border-color: var(--cp-neon-blue); }
        .num-btn.selected-digit {
            background: var(--cp-neon-blue); color: #000; box-shadow: 0 0 15px var(--cp-neon-blue);
            border-color: #fff; transform: scale(1.05); z-index: 5;
        }
        .num-btn:active { transform: scale(0.95); }
        .num-btn.completed { opacity: 0.3; border-color: transparent; }
        .num-btn.erase { border-color: rgba(255, 0, 255, 0.3); color: var(--cp-neon-magenta); }

        /* Overlays */
        .overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(16, 24, 39, 0.95); backdrop-filter: blur(10px);
            display: none; flex-direction: column; align-items: center; justify-content: center;
            z-index: 20; border: 1px solid var(--cp-neon-blue);
        }
        .overlay-title {
            font-size: 2rem; font-weight: 800; color: var(--cp-neon-blue); margin-bottom: 20px;
            text-shadow: 0 0 20px var(--cp-neon-blue); text-align: center;
        }
        .overlay-subtitle { font-size: 1.1rem; color: var(--cp-neon-green); margin-bottom: 30px; font-family: monospace; }

        @media (max-width: 480px) {
            body { padding: 20px 10px; align-items: flex-start; }
            .game-card { padding: 16px; margin-bottom: 20px; }
            .title { font-size: 1.4rem; }
            .cell { font-size: 1.3rem; }
            .num-btn { font-size: 1.4rem; }
            .mode-btn { font-size: 0.8rem; }
        }
    </style>
</head>
<body>

    <div class="crt-overlay"></div>

    <div class="game-card">
        <div class="header">
            <div class="title">CyberSudoku</div>
            <div class="stats-area">
                <div class="stat-item" title="ÈåØË™§Ê¨°Êï∏">
                    <span id="mistakeCount" style="color: var(--cp-neon-magenta)">0</span>/3
                </div>
                <div class="stat-item">
                    <span id="timer">00:00</span>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <select id="difficulty">
                    <option value="30">Easy</option>
                    <option value="45" selected>Medium</option>
                    <option value="55">Hard</option>
                </select>
            </div>
            <div class="control-group">
                <button class="icon-btn" onclick="undo()" id="btn-undo" title="Êí§Èä∑ (Z)">‚Ü∂</button>
                <button class="icon-btn" onclick="togglePause()" title="Êö´ÂÅú/ÁπºÁ∫å">‚ùö‚ùö</button>
                <button class="icon-btn" onclick="toggleSound()" id="btn-sound" title="Èü≥Êïà">üîä</button>
                <button class="icon-btn" onclick="resetBoard()" title="ÈáçÁΩÆ">‚Üª</button>
                <button class="btn-new-game" onclick="confirmNewGame()">NEW</button>
            </div>
        </div>

        <div class="board-wrapper">
            <div class="sudoku-board" id="board"></div>
            
            <div class="overlay" id="pausedOverlay">
                <div class="overlay-title">SYSTEM PAUSED</div>
                <button class="btn-new-game" onclick="togglePause()">RESUME</button>
            </div>

            <div class="overlay" id="victoryOverlay" style="border-color: var(--cp-neon-green);">
                <div class="overlay-title" style="color: var(--cp-neon-green);">MISSION COMPLETE</div>
                <div class="overlay-subtitle" id="victoryStats"></div>
                <button class="btn-new-game" onclick="confirmNewGame()">NEXT LEVEL</button>
            </div>
        </div>

        <div class="numpad-container">
            <!-- Mode Switcher -->
            <div class="mode-switch">
                <button class="mode-btn active" id="mode-cell" onclick="setMode('cell')">ÂÖàÈÅ∏Ê†ºÂ≠ê (Cell-First)</button>
                <button class="mode-btn" id="mode-digit" onclick="setMode('digit')">ÂÖàÈÅ∏Êï∏Â≠ó (Digit-First)</button>
            </div>

            <div class="tools-row">
                <button class="tool-btn" id="btn-pencil" onclick="togglePencilMode()">
                    ‚úé PENCIL <span id="pencil-status" style="opacity:0.7; margin-left: 5px;">OFF</span>
                </button>
                <button class="tool-btn" onclick="autoNotes()" title="Ëá™ÂãïÂ°´ÂÖ•ÊâÄÊúâÂÄôÈÅ∏Êï∏">
                    üìù AUTO NOTES
                </button>
                <button class="tool-btn" onclick="getHint()">
                    üí° HACK (+20s)
                </button>
            </div>

            <div class="numpad">
                <button class="num-btn" id="btn-1" onclick="handleInput(1)">1</button>
                <button class="num-btn" id="btn-2" onclick="handleInput(2)">2</button>
                <button class="num-btn" id="btn-3" onclick="handleInput(3)">3</button>
                <button class="num-btn" id="btn-4" onclick="handleInput(4)">4</button>
                <button class="num-btn" id="btn-5" onclick="handleInput(5)">5</button>
                <button class="num-btn" id="btn-6" onclick="handleInput(6)">6</button>
                <button class="num-btn" id="btn-7" onclick="handleInput(7)">7</button>
                <button class="num-btn" id="btn-8" onclick="handleInput(8)">8</button>
                <button class="num-btn" id="btn-9" onclick="handleInput(9)">9</button>
                <button class="num-btn erase" onclick="handleInput(0)">DEL</button>
            </div>
        </div>
    </div>

    <script>
        // --- Sound System (Web Audio API) ---
        const SoundFX = {
            ctx: null, enabled: true,
            init: function() {
                if (!this.ctx) {
                    const AC = window.AudioContext || window.webkitAudioContext;
                    this.ctx = new AC();
                }
                if (this.ctx.state === 'suspended') this.ctx.resume();
            },
            playTone: function(freq, type, duration, vol = 0.1) {
                if (!this.enabled || !this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type; osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start(); osc.stop(this.ctx.currentTime + duration);
            },
            click: function() { this.playTone(800, 'square', 0.05, 0.05); },
            input: function() { this.playTone(1200, 'sine', 0.1, 0.05); },
            error: function() { this.playTone(150, 'sawtooth', 0.3, 0.15); },
            undo: function() { this.playTone(400, 'triangle', 0.15, 0.1); },
            victory: function() { 
                if (!this.enabled || !this.ctx) return;
                [523, 659, 784, 1046].forEach((f, i) => setTimeout(() => this.playTone(f, 'triangle', 0.3, 0.1), i*100));
            }
        };

        // --- Game Logic ---
        let grid = [], displayGrid = [], initialGrid = [], notesGrid = [], historyStack = [];
        let selectedCellIndex = -1;
        let selectedDigit = -1; // For Digit-First Mode
        let inputMode = 'cell'; // 'cell' or 'digit'
        let isPencilMode = false;
        let mistakes = 0;
        let isPaused = false;
        let timerInterval;
        let secondsElapsed = 0;
        let gameActive = false;
        const STORAGE_KEY = 'cybersudoku_v4_save';

        window.onload = function() {
            createBoardUI();
            if (!loadGame()) newGame();
            
            // Interaction to unlock Audio
            document.body.addEventListener('click', () => { if(SoundFX.enabled) SoundFX.init(); }, { once: true });
            
            // Visibility API for Auto Pause
            document.addEventListener("visibilitychange", () => {
                if (document.hidden && gameActive && !isPaused) {
                    togglePause();
                }
            });

            document.addEventListener('keydown', (e) => {
                if (isPaused || !gameActive) return;
                if(SoundFX.enabled) SoundFX.init();
                
                const key = e.key.toLowerCase();
                if (key === 'n') togglePencilMode();
                if (key === 'm') toggleInputMode(); // Shortcut for mode switch
                if ((e.ctrlKey || e.metaKey) && key === 'z') { e.preventDefault(); undo(); }
                
                // Shift key temporarily toggles pencil mode for next input logic
                const isShift = e.shiftKey; 

                if (e.key >= '1' && e.key <= '9') {
                    if (isShift && inputMode === 'cell') {
                         // Quick Note shortcut
                         const tempPencil = isPencilMode;
                         isPencilMode = true;
                         handleInput(parseInt(e.key));
                         isPencilMode = tempPencil;
                    } else {
                        handleInput(parseInt(e.key));
                    }
                } else if (['Backspace', 'Delete', '0'].includes(e.key)) {
                    handleInput(0);
                } else {
                    if (['ArrowUp', 'w'].includes(key)) moveSelection('up');
                    else if (['ArrowDown', 's'].includes(key)) moveSelection('down');
                    else if (['ArrowLeft', 'a'].includes(key)) moveSelection('left');
                    else if (['ArrowRight', 'd'].includes(key)) moveSelection('right');
                }
            });

            window.addEventListener('beforeunload', () => { if(gameActive) saveGame(); });
        };

        // --- Core Functions ---
        function createBoardUI() {
            const board = document.getElementById('board');
            board.innerHTML = '';
            for (let i = 0; i < 81; i++) {
                let cell = document.createElement('div');
                cell.className = 'cell';
                cell.id = `cell-${i}`;
                cell.onclick = () => onCellClick(i);
                
                let notesDiv = document.createElement('div');
                notesDiv.className = 'notes-grid';
                for(let n=1; n<=9; n++){
                    let s = document.createElement('span');
                    s.className = 'note-num';
                    s.id = `cell-${i}-note-${n}`;
                    notesDiv.appendChild(s);
                }
                cell.appendChild(notesDiv);
                board.appendChild(cell);
            }
        }

        function setMode(mode) {
            inputMode = mode;
            document.getElementById('mode-cell').classList.toggle('active', mode === 'cell');
            document.getElementById('mode-digit').classList.toggle('active', mode === 'digit');
            SoundFX.click();
            
            // Reset selections when switching
            if (mode === 'cell') {
                selectedDigit = -1;
                updateNumpadStatus();
                // Select last cell if exists
                if(selectedCellIndex === -1) selectedCellIndex = 0;
            } else {
                // In digit mode, we deselect cell initially to focus on digit
                selectedCellIndex = -1;
                // If no digit selected, select 1
                if(selectedDigit === -1) selectedDigit = 1;
            }
            renderBoard();
            updateNumpadStatus();
        }

        function toggleInputMode() {
            setMode(inputMode === 'cell' ? 'digit' : 'cell');
        }

        // Unified Handler for Numpad Clicks and Keyboard Numbers
        function handleInput(num) {
            if (!gameActive || isPaused) return;

            if (inputMode === 'cell') {
                // Cell-First Mode: Input number into selected cell
                inputNumberIntoCell(selectedCellIndex, num);
            } else {
                // Digit-First Mode: Select the digit
                if (num === 0) return; // '0' / Erase doesn't make sense as a "mode", maybe use it to erase clicked cells? For now ignore.
                selectedDigit = num;
                SoundFX.click();
                renderBoard(); // Highlight all instances of this number
                updateNumpadStatus();
            }
        }

        // Unified Handler for Cell Clicks
        function onCellClick(index) {
            if (!gameActive || isPaused) return;

            if (inputMode === 'cell') {
                // Cell-First: Just select the cell
                selectedCellIndex = index;
                SoundFX.click();
                renderBoard();
            } else {
                // Digit-First: Try to fill the clicked cell with selectedDigit
                if (selectedDigit !== -1) {
                    if (initialGrid[index] !== 0) {
                        // Cannot edit fixed cells, just play sound
                        SoundFX.error();
                        return;
                    }
                    
                    // Logic to toggle: if cell already has this number, clear it (or note). If not, set it.
                    const currentVal = displayGrid[index];
                    const hasNote = notesGrid[index].has(selectedDigit);
                    
                    if (isPencilMode) {
                        // Toggle Note
                        inputNumberIntoCell(index, selectedDigit); // Reuse logic
                    } else {
                        // If cell is empty, fill it. If cell has same number, clear it.
                        if (currentVal === selectedDigit) {
                             inputNumberIntoCell(index, 0); // Clear
                        } else {
                             inputNumberIntoCell(index, selectedDigit); // Fill
                        }
                    }
                }
            }
        }

        function inputNumberIntoCell(idx, num) {
            if (idx === -1 || initialGrid[idx] !== 0) return;

            const currentVal = displayGrid[idx];
            const currentNotes = new Set(notesGrid[idx]);

            if (isPencilMode) {
                if (num === 0) {
                    // Clear all notes
                    if (notesGrid[idx].size > 0) {
                        pushToHistory(idx, currentVal, currentNotes, 0, 'pencil');
                        notesGrid[idx].clear();
                        SoundFX.input();
                    }
                } else {
                    // Toggle specific note
                    pushToHistory(idx, currentVal, currentNotes, num, 'pencil');
                    if (notesGrid[idx].has(num)) notesGrid[idx].delete(num); else notesGrid[idx].add(num);
                    SoundFX.input();
                }
            } else {
                if (currentVal === num) return;
                
                pushToHistory(idx, currentVal, currentNotes, num, 'input');
                
                if (num === 0) {
                    displayGrid[idx] = 0;
                    SoundFX.input();
                } else {
                    displayGrid[idx] = num;
                    notesGrid[idx].clear();
                    
                    if (num !== window.solutionGrid[idx]) {
                        mistakes++;
                        updateMistakes();
                        SoundFX.error();
                    } else {
                        clearRelatedNotes(idx, num);
                        SoundFX.input();
                        checkCompletedNumber(num);
                    }
                }
            }
            renderBoard();
            updateNumpadStatus();
            checkWinCondition();
            saveGame();
        }

        // Check if a number is fully completed (9 placed), then in digit mode, switch to another
        function checkCompletedNumber(num) {
            let count = 0;
            displayGrid.forEach(n => { if (n === num) count++; });
            if (count >= 9 && inputMode === 'digit' && selectedDigit === num) {
                // Find next incomplete number
                for(let i=1; i<=9; i++) {
                    let c = 0;
                    displayGrid.forEach(n => { if (n === i) c++; });
                    if (c < 9) {
                        selectedDigit = i;
                        updateNumpadStatus();
                        renderBoard();
                        return;
                    }
                }
                selectedDigit = -1; // All done?
            }
        }

        // --- Auto Notes Feature ---
        function autoNotes() {
            if (!gameActive || isPaused) return;
            if(!confirm("Fill all candidates? This will overwrite existing notes.")) return;
            
            SoundFX.click();
            
            // Save state for undo (complex batch undo not implemented fully, we save one generic action or clear history? 
            // For simplicity in this file, we won't add massive batch undo history, or we loop.)
            // Let's iterate and just fill.
            
            for (let i = 0; i < 81; i++) {
                if (displayGrid[i] === 0) {
                    notesGrid[i].clear();
                    for (let n = 1; n <= 9; n++) {
                        if (checkIfSafe(Math.floor(i/9), i%9, n)) {
                            notesGrid[i].add(n);
                        }
                    }
                }
            }
            renderBoard();
            saveGame();
        }

        // --- Render Logic Updated for Digit Mode ---
        function renderBoard() {
            for (let i = 0; i < 81; i++) {
                const cell = document.getElementById(`cell-${i}`);
                const val = displayGrid[i];
                let classes = ['cell'];
                
                // Highlight logic
                if (initialGrid[i] !== 0) classes.push('fixed');
                else if (val !== 0) classes.push('user-input');
                if (val !== 0 && initialGrid[i] === 0 && val !== window.solutionGrid[i]) classes.push('error');

                // Selection Logic
                if (inputMode === 'cell') {
                    if (i === selectedCellIndex) classes.push('selected');
                    // Highlight same numbers
                    if (selectedCellIndex !== -1 && val !== 0 && val === displayGrid[selectedCellIndex]) classes.push('same-number');
                } else {
                    // Digit Mode: Highlight all cells with selectedDigit
                    if (selectedDigit !== -1 && val === selectedDigit) classes.push('same-number');
                }

                cell.className = '';
                cell.classList.add(...classes);
                
                // Content
                let txtNode = Array.from(cell.childNodes).find(n => n.nodeType === Node.TEXT_NODE);
                if(txtNode) txtNode.textContent = val !== 0 ? val : ''; else cell.insertBefore(document.createTextNode(val !== 0 ? val : ''), cell.firstChild);

                // Notes
                const notesDiv = cell.querySelector('.notes-grid');
                if (val !== 0) {
                    notesDiv.style.display = 'none';
                } else {
                    notesDiv.style.display = 'grid';
                    for(let n=1; n<=9; n++) {
                        const span = document.getElementById(`cell-${i}-note-${n}`);
                        span.innerText = notesGrid[i].has(n) ? n : '';
                        // Highlight note if it matches selected digit in digit mode
                        span.style.color = (inputMode === 'digit' && n === selectedDigit) ? 'var(--cp-neon-blue)' : '';
                        span.style.fontWeight = (inputMode === 'digit' && n === selectedDigit) ? 'bold' : '';
                    }
                }
            }
            
            if (inputMode === 'cell') highlightRelated(selectedCellIndex);
        }

        function highlightRelated(index) {
            if (index === -1) return;
            const row = Math.floor(index / 9); const col = index % 9;
            for (let i = 0; i < 81; i++) {
                if (i === index) continue;
                const r = Math.floor(i / 9); const c = i % 9;
                const boxR = Math.floor(r / 3); const boxC = Math.floor(c / 3);
                const currentBoxR = Math.floor(row / 3); const currentBoxC = Math.floor(col / 3);
                if (r === row || c === col || (boxR === currentBoxR && boxC === currentBoxC)) {
                    document.getElementById(`cell-${i}`).classList.add('highlight');
                }
            }
        }

        function updateNumpadStatus() {
            const counts = Array(10).fill(0);
            displayGrid.forEach(n => { if (n !== 0) counts[n]++; });
            
            for (let n = 1; n <= 9; n++) {
                const btn = document.getElementById(`btn-${n}`);
                btn.className = 'num-btn'; // Reset
                if (counts[n] >= 9) btn.classList.add('completed');
                
                if (inputMode === 'digit' && selectedDigit === n) {
                    btn.classList.add('selected-digit');
                }
            }
        }

        // --- Previous Helper Functions (Logic unchanged) ---
        function pushToHistory(index, oldVal, oldNotes, newVal, type) {
            historyStack.push({ index: index, oldVal: oldVal, oldNotes: new Set(oldNotes), newVal: newVal, type: type });
            if (historyStack.length > 50) historyStack.shift();
            document.getElementById('btn-undo').disabled = false;
        }

        function undo() {
            if (historyStack.length === 0 || !gameActive || isPaused) return;
            SoundFX.undo();
            const action = historyStack.pop();
            const idx = action.index;
            if (action.type === 'input') { displayGrid[idx] = action.oldVal; notesGrid[idx] = action.oldNotes; }
            else if (action.type === 'pencil') { notesGrid[idx] = action.oldNotes; }
            renderBoard(); updateNumpadStatus();
            document.getElementById('btn-undo').disabled = historyStack.length === 0;
            saveGame();
        }

        function generateSudoku(removeCount) {
            grid = Array(81).fill(0); fillDiagonal(); fillRemaining(0, 3);
            window.solutionGrid = [...grid]; displayGrid = [...grid];
            let attempts = removeCount;
            while (attempts > 0) { let id = Math.floor(Math.random() * 81); if (displayGrid[id] !== 0) { displayGrid[id] = 0; attempts--; } }
            initialGrid = [...displayGrid];
        }
        function fillDiagonal() { for (let i = 0; i < 9; i = i + 3) fillBox(i, i); }
        function unUsedInBox(rowStart, colStart, num) { for (let i = 0; i < 3; i++) for (let j = 0; j < 3; j++) if (grid[(rowStart + i) * 9 + (colStart + j)] === num) return false; return true; }
        function fillBox(row, col) { let num; for (let i = 0; i < 3; i++) for (let j = 0; j < 3; j++) { do { num = Math.floor(Math.random() * 9) + 1; } while (!unUsedInBox(row, col, num)); grid[(row + i) * 9 + (col + j)] = num; } }
        function checkIfSafe(i, j, num) {
            for (let k = 0; k < 9; k++) if (grid[i * 9 + k] === num) return false;
            for (let k = 0; k < 9; k++) if (grid[k * 9 + j] === num) return false;
            let rs = i - i % 3; let cs = j - j % 3;
            for (let k = 0; k < 3; k++) for (let l = 0; l < 3; l++) if (grid[(rs + k) * 9 + (cs + l)] === num) return false;
            return true;
        }
        function fillRemaining(i, j) {
            if (j >= 9 && i < 8) { i++; j = 0; }
            if (i >= 9 && j >= 9) return true;
            if (i < 3) { if (j < 3) j = 3; } else if (i < 6) { if (j === (Math.floor(i / 3)) * 3) j += 3; } else { if (j === 6) { i++; j = 0; if (i >= 9) return true; } }
            for (let num = 1; num <= 9; num++) {
                if (checkIfSafe(i, j, num)) { grid[i * 9 + j] = num; if (fillRemaining(i, j + 1)) return true; grid[i * 9 + j] = 0; }
            } return false;
        }
        function clearRelatedNotes(index, num) {
            const row = Math.floor(index / 9); const col = index % 9;
            const br = Math.floor(row / 3); const bc = Math.floor(col / 3);
            for (let i = 0; i < 81; i++) {
                if (i === index) continue;
                const r = Math.floor(i / 9); const c = i % 9;
                if (r === row || c === col || (Math.floor(r / 3) === br && Math.floor(c / 3) === bc)) {
                    if (notesGrid[i].has(num)) notesGrid[i].delete(num);
                }
            }
        }
        function togglePencilMode() {
            SoundFX.click(); isPencilMode = !isPencilMode;
            const btn = document.getElementById('btn-pencil');
            document.getElementById('pencil-status').innerText = isPencilMode ? "ON" : "OFF";
            btn.classList.toggle('active', isPencilMode);
        }
        function togglePause() {
            if (!gameActive) return; SoundFX.click(); isPaused = !isPaused;
            document.getElementById('pausedOverlay').style.display = isPaused ? 'flex' : 'none';
            if (isPaused) clearInterval(timerInterval); else startTimer();
        }
        function toggleSound() {
            SoundFX.enabled = !SoundFX.enabled;
            document.getElementById('btn-sound').innerText = SoundFX.enabled ? 'üîä' : 'üîá';
            if (SoundFX.enabled) SoundFX.init();
        }
        function confirmNewGame() { SoundFX.click(); if (confirm("START NEW MISSION?")) newGame(); }
        function newGame() {
            localStorage.removeItem(STORAGE_KEY);
            generateSudoku(parseInt(document.getElementById('difficulty').value));
            mistakes = 0; historyStack = []; secondsElapsed = 0;
            notesGrid = Array(81).fill().map(() => new Set());
            inputMode = 'cell'; setMode('cell');
            updateMistakes(); clearInterval(timerInterval); startTimer();
            isPaused = false; gameActive = true;
            document.getElementById('pausedOverlay').style.display = 'none';
            document.getElementById('victoryOverlay').style.display = 'none';
            renderBoard(); saveGame();
        }
        function resetBoard() {
             if(!confirm("RESTART LEVEL?")) return;
             displayGrid = [...initialGrid]; notesGrid = Array(81).fill().map(() => new Set());
             mistakes = 0; historyStack = [];
             updateMistakes(); renderBoard(); saveGame();
        }
        function saveGame() {
            if (!gameActive) return;
            localStorage.setItem(STORAGE_KEY, JSON.stringify({
                grid, displayGrid, initialGrid, notesGrid: notesGrid.map(s => Array.from(s)),
                historyStack, mistakes, secondsElapsed, difficulty: document.getElementById('difficulty').value
            }));
        }
        function loadGame() {
            const s = localStorage.getItem(STORAGE_KEY); if (!s) return false;
            try {
                const d = JSON.parse(s);
                grid = d.grid; displayGrid = d.displayGrid; initialGrid = d.initialGrid;
                window.solutionGrid = [...grid];
                notesGrid = d.notesGrid.map(a => new Set(a));
                historyStack = d.historyStack || []; mistakes = d.mistakes; secondsElapsed = d.secondsElapsed;
                document.getElementById('difficulty').value = d.difficulty || "45";
                updateMistakes(); startTimer(); gameActive = true; isPaused = false;
                document.getElementById('pausedOverlay').style.display = 'none';
                document.getElementById('victoryOverlay').style.display = 'none';
                renderBoard(); return true;
            } catch { return false; }
        }
        function updateMistakes() {
            document.getElementById('mistakeCount').innerText = mistakes;
            if (mistakes >= 3) document.getElementById('mistakeCount').style.textShadow = "0 0 10px red";
        }
        function startTimer() { clearInterval(timerInterval); timerInterval = setInterval(() => { secondsElapsed++; 
            const m = Math.floor(secondsElapsed / 60).toString().padStart(2, '0');
            const s = (secondsElapsed % 60).toString().padStart(2, '0');
            document.getElementById('timer').innerText = `${m}:${s}`;
        }, 1000); }
        function checkWinCondition() {
            if (displayGrid.includes(0)) return;
            if (displayGrid.every((v, i) => v === window.solutionGrid[i])) {
                clearInterval(timerInterval); gameActive = false; localStorage.removeItem(STORAGE_KEY);
                SoundFX.victory();
                document.getElementById('victoryStats').innerText = `TIME: ${document.getElementById('timer').innerText} | ERRORS: ${mistakes}`;
                document.getElementById('victoryOverlay').style.display = 'flex';
            }
        }
        function moveSelection(d) {
            if (selectedCellIndex === -1) { onCellClick(0); return; }
            let r = Math.floor(selectedCellIndex / 9), c = selectedCellIndex % 9;
            if (d === 'up') r = r > 0 ? r - 1 : 8; if (d === 'down') r = r < 8 ? r + 1 : 0;
            if (d === 'left') c = c > 0 ? c - 1 : 8; if (d === 'right') c = c < 8 ? c + 1 : 0;
            onCellClick(r * 9 + c);
        }
        function getHint() {
            if (!gameActive || isPaused) return; SoundFX.input();
            let e = []; displayGrid.forEach((v, i) => { if (v === 0) e.push(i); });
            if (e.length === 0) return;
            let i = e[Math.floor(Math.random() * e.length)];
            pushToHistory(i, 0, new Set(notesGrid[i]), window.solutionGrid[i], 'input');
            displayGrid[i] = window.solutionGrid[i]; notesGrid[i].clear();
            secondsElapsed += 20; renderBoard(); updateNumpadStatus(); checkWinCondition(); saveGame();
        }
    </script>
</body>
</html>
